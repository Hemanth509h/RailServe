{% extends "base.html" %}

{% block title %}Admin - Group Bookings Management - RailServe{% endblock %}

{% block extra_css %}
<style>
.admin-container {
    background: linear-gradient(135deg, #2d3748 0%, #4a5568 100%);
    min-height: 100vh;
    padding: 2rem 0;
}

.content-wrapper {
    max-width: 1400px;
    margin: 0 auto;
    padding: 0 1rem;
}

.admin-header {
    background: white;
    border-radius: 20px;
    padding: 2rem;
    margin-bottom: 2rem;
    box-shadow: 0 15px 35px rgba(0,0,0,0.1);
    text-align: center;
}

.admin-title {
    color: #2d3748;
    font-size: 2.5rem;
    font-weight: 700;
    margin: 0 0 1rem 0;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 1rem;
}

.admin-subtitle {
    color: #718096;
    font-size: 1.125rem;
    margin: 0;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 2rem;
    margin-bottom: 3rem;
}

.stat-card {
    background: white;
    border-radius: 16px;
    padding: 2rem;
    text-align: center;
    box-shadow: 0 8px 20px rgba(0,0,0,0.1);
    position: relative;
    overflow: hidden;
}

.stat-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.stat-value {
    font-size: 2.5rem;
    font-weight: 700;
    color: #2d3748;
    margin-bottom: 0.5rem;
}

.stat-label {
    color: #718096;
    font-size: 1.1rem;
    font-weight: 500;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
}

.groups-section {
    background: white;
    border-radius: 20px;
    padding: 2rem;
    box-shadow: 0 15px 35px rgba(0,0,0,0.1);
}

.section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid #e2e8f0;
}

.section-title {
    color: #2d3748;
    font-size: 1.5rem;
    font-weight: 600;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.groups-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 1rem;
}

.groups-table th,
.groups-table td {
    padding: 1rem;
    text-align: left;
    border-bottom: 1px solid #e2e8f0;
}

.groups-table th {
    background: #f8fafc;
    font-weight: 600;
    color: #2d3748;
    position: sticky;
    top: 0;
}

.groups-table tr:hover {
    background: #f8fafc;
}

.group-name {
    font-weight: 600;
    color: #2d3748;
    margin-bottom: 0.25rem;
}

.group-meta {
    font-size: 0.875rem;
    color: #718096;
}

.status-badge {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
}

.status-pending {
    background: #fef5e7;
    color: #dd6b20;
}

.status-confirmed {
    background: #d6f5d6;
    color: #2f855a;
}

.status-cancelled {
    background: #fed7d7;
    color: #c53030;
}

.type-badge {
    display: inline-block;
    padding: 0.25rem 0.5rem;
    border-radius: 8px;
    font-size: 0.75rem;
    font-weight: 500;
    background: #e2e8f0;
    color: #4a5568;
}

.discount-badge {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: 8px;
    font-size: 0.75rem;
    font-weight: 600;
}

.amount-display {
    font-weight: 600;
    color: #2d3748;
}

.date-display {
    color: #718096;
    font-size: 0.875rem;
}

.action-buttons {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.btn {
    padding: 0.5rem 1rem;
    border-radius: 8px;
    text-decoration: none;
    font-weight: 500;
    font-size: 0.875rem;
    transition: all 0.3s ease;
    border: none;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
}

.btn-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.btn-secondary {
    background: #e2e8f0;
    color: #4a5568;
}

.btn-danger {
    background: #e53e3e;
    color: white;
}

.btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.empty-state {
    text-align: center;
    padding: 4rem 2rem;
    color: #718096;
}

.empty-icon {
    font-size: 4rem;
    margin-bottom: 1rem;
    opacity: 0.5;
}

.filter-section {
    background: #f8fafc;
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 2rem;
}

.filter-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    align-items: end;
}

.form-group {
    margin: 0;
}

.form-label {
    display: block;
    font-weight: 500;
    color: #2d3748;
    margin-bottom: 0.5rem;
    font-size: 0.875rem;
}

.form-control {
    width: 100%;
    padding: 0.5rem;
    border: 1px solid #e2e8f0;
    border-radius: 6px;
    font-size: 0.875rem;
}

@media (max-width: 768px) {
    .stats-grid {
        grid-template-columns: 1fr;
    }
    
    .section-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 1rem;
    }
    
    .groups-table {
        font-size: 0.875rem;
    }
    
    .groups-table th,
    .groups-table td {
        padding: 0.75rem 0.5rem;
    }
    
    .action-buttons {
        flex-direction: column;
    }
    
    .filter-grid {
        grid-template-columns: 1fr;
    }
}

@media (max-width: 480px) {
    .admin-title {
        font-size: 2rem;
        flex-direction: column;
        gap: 0.5rem;
    }
    
    .content-wrapper {
        padding: 0 0.5rem;
    }
    
    .admin-header,
    .groups-section {
        padding: 1.5rem;
        border-radius: 12px;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="admin-container">
    <div class="content-wrapper">
        <div class="admin-header">
            <h1 class="admin-title">
                <i class="fas fa-users-cog"></i>
                Group Bookings Management
            </h1>
            <p class="admin-subtitle">Monitor and manage all group bookings in the system</p>
        </div>

        <!-- Statistics Overview -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value">{{ total_groups }}</div>
                <div class="stat-label">
                    <i class="fas fa-users"></i> Total Groups
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{{ active_groups }}</div>
                <div class="stat-label">
                    <i class="fas fa-check-circle"></i> Active Groups
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{{ total_passengers }}</div>
                <div class="stat-label">
                    <i class="fas fa-user-friends"></i> Total Passengers
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{{ groups|selectattr('status', 'equalto', 'confirmed')|list|length }}</div>
                <div class="stat-label">
                    <i class="fas fa-thumbs-up"></i> Confirmed Groups
                </div>
            </div>
        </div>

        <!-- Groups Table -->
        <div class="groups-section">
            <div class="section-header">
                <h2 class="section-title">
                    <i class="fas fa-list"></i>
                    All Group Bookings
                </h2>
            </div>

            {% if groups %}
                <div style="overflow-x: auto;">
                    <table class="groups-table">
                        <thead>
                            <tr>
                                <th>Group Details</th>
                                <th>Leader</th>
                                <th>Type & Passengers</th>
                                <th>Status</th>
                                <th>Amount & Discount</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for group in groups %}
                            <tr>
                                <td>
                                    <div class="group-name">{{ group.group_name }}</div>
                                    <div class="group-meta">ID: {{ group.id }}</div>
                                </td>
                                <td>
                                    <div class="group-name">{{ group.group_leader.username }}</div>
                                    <div class="group-meta">{{ group.contact_email }}</div>
                                </td>
                                <td>
                                    <span class="type-badge">{{ group.booking_type.title() }}</span><br>
                                    <div class="group-meta" style="margin-top: 0.5rem;">
                                        {{ group.total_passengers }} passengers
                                    </div>
                                </td>
                                <td>
                                    <span class="status-badge status-{{ group.status }}">
                                        {{ group.status.title() }}
                                    </span>
                                </td>
                                <td>
                                    <div class="amount-display">â‚¹{{ "%.0f"|format(group.get_total_amount()) }}</div>
                                    {% if group.group_discount_rate > 0 %}
                                        <span class="discount-badge">{{ group.group_discount_rate }}% off</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="date-display">
                                        {{ group.created_at.strftime('%d %b %Y') }}<br>
                                        <small>{{ group.created_at.strftime('%I:%M %p') }}</small>
                                    </div>
                                </td>
                                <td>
                                    <div class="action-buttons">
                                        <a href="{{ url_for('groups.enhanced_manage_group', group_id=group.id) }}" 
                                           class="btn btn-primary">
                                            <i class="fas fa-eye"></i> View
                                        </a>
                                        {% if group.status != 'cancelled' %}
                                            <form method="POST" 
                                                  action="{{ url_for('groups.cancel_group_booking', group_id=group.id) }}" 
                                                  style="display: inline;"
                                                  onsubmit="return confirm('Cancel this group booking?')">
                                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                                <button type="submit" class="btn btn-danger">
                                                    <i class="fas fa-ban"></i> Cancel
                                                </button>
                                            </form>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="empty-state">
                    <div class="empty-icon">
                        <i class="fas fa-users"></i>
                    </div>
                    <h3>No Group Bookings Found</h3>
                    <p>No group bookings have been created yet.</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Add sorting functionality
    const table = document.querySelector('.groups-table');
    if (table) {
        const headers = table.querySelectorAll('th');
        headers.forEach((header, index) => {
            if (index < 6) { // Don't make actions column sortable
                header.style.cursor = 'pointer';
                header.addEventListener('click', () => sortTable(table, index));
            }
        });
    }
});

function sortTable(table, column) {
    const tbody = table.querySelector('tbody');
    const rows = Array.from(tbody.querySelectorAll('tr'));
    
    rows.sort((a, b) => {
        const aText = a.children[column].textContent.trim();
        const bText = b.children[column].textContent.trim();
        
        // Try to parse as numbers for amount columns
        if (column === 4) { // Amount column
            const aNum = parseFloat(aText.replace(/[â‚¹,]/g, ''));
            const bNum = parseFloat(bText.replace(/[â‚¹,]/g, ''));
            return aNum - bNum;
        }
        
        return aText.localeCompare(bText);
    });
    
    // Re-append sorted rows
    rows.forEach(row => tbody.appendChild(row));
}
</script>
{% endblock %}
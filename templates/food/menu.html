{% extends "base.html" %}

{% block title %}{{ restaurant.name }} Menu - RailServe{% endblock %}

{% block head %}
<meta name="csrf-token" content="{{ csrf_token() }}">
{% endblock %}

{% block extra_css %}
<style>
/* Modern Swiggy/Zomato inspired menu styling */
.menu-container {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    padding: 2rem 0;
}

.content-wrapper {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 1rem;
}

.menu-header {
    background: white;
    border-radius: 20px;
    padding: 2rem;
    margin-bottom: 2rem;
    box-shadow: 0 10px 40px rgba(0,0,0,0.1);
    position: sticky;
    top: 20px;
    z-index: 100;
}

.header-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 1rem;
}

.restaurant-title {
    color: #2d3748;
    font-size: 2.5rem;
    font-weight: 700;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 1rem;
}

.header-actions {
    display: flex;
    gap: 1rem;
    align-items: center;
}

.cart-btn {
    background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
    color: white;
    border: none;
    padding: 0.75rem 1.5rem;
    border-radius: 50px;
    font-weight: 600;
    text-decoration: none;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(72, 187, 120, 0.4);
    position: relative;
}

.cart-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(72, 187, 120, 0.6);
    color: white;
    text-decoration: none;
}

.cart-count {
    background: #e53e3e;
    color: white;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.75rem;
    font-weight: 700;
    position: absolute;
    top: -8px;
    right: -8px;
    box-shadow: 0 2px 8px rgba(229, 62, 62, 0.4);
}

.back-btn {
    background: rgba(102, 126, 234, 0.1);
    color: #667eea;
    border: 2px solid #667eea;
    padding: 0.75rem 1.5rem;
    border-radius: 50px;
    font-weight: 600;
    text-decoration: none;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    transition: all 0.3s ease;
}

.back-btn:hover {
    background: #667eea;
    color: white;
    text-decoration: none;
}

.restaurant-info-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 16px;
    padding: 2rem;
    color: white;
    margin-bottom: 2rem;
    box-shadow: 0 8px 32px rgba(102, 126, 234, 0.3);
}

.info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 2rem;
}

.info-section h5 {
    margin: 0 0 1rem 0;
    font-weight: 600;
    font-size: 1.25rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.info-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.75rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid rgba(255, 255, 255, 0.2);
}

.info-item:last-child {
    border-bottom: none;
    margin-bottom: 0;
}

.info-label {
    font-weight: 500;
    opacity: 0.9;
}

.info-value {
    font-weight: 600;
}

.rating-stars {
    color: #ffd700;
    margin-right: 0.5rem;
}

.delivery-alert {
    background: rgba(255, 255, 255, 0.95);
    border-radius: 16px;
    padding: 1.5rem;
    margin-bottom: 2rem;
    border-left: 4px solid #ed8936;
}

.alert-content {
    color: #744210;
    font-weight: 500;
    margin: 0;
}

.menu-categories {
    display: flex;
    flex-direction: column;
    gap: 2rem;
}

.category-section {
    background: white;
    border-radius: 20px;
    overflow: hidden;
    box-shadow: 0 8px 32px rgba(0,0,0,0.1);
}

.category-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 1.5rem 2rem;
    margin: 0;
    font-size: 1.5rem;
    font-weight: 600;
}

.category-items {
    padding: 2rem;
}

.items-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 1.5rem;
}

.menu-item-card {
    background: #f8fafc;
    border-radius: 16px;
    padding: 1.5rem;
    transition: all 0.3s ease;
    border: 2px solid transparent;
    position: relative;
    overflow: hidden;
}

.menu-item-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 12px 28px rgba(0,0,0,0.12);
    border-color: #667eea;
}

.menu-item-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    transform: scaleX(0);
    transition: transform 0.3s ease;
}

.menu-item-card:hover::before {
    transform: scaleX(1);
}

.item-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 1rem;
}

.item-name {
    color: #2d3748;
    font-size: 1.25rem;
    font-weight: 600;
    margin: 0;
    flex: 1;
}

.food-type-badge {
    padding: 0.25rem 0.75rem;
    border-radius: 50px;
    font-size: 0.75rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 0.25rem;
}

.veg-badge {
    background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
    color: white;
}

.non-veg-badge {
    background: linear-gradient(135deg, #e53e3e 0%, #c53030 100%);
    color: white;
}

.item-description {
    color: #718096;
    font-size: 0.875rem;
    line-height: 1.5;
    margin-bottom: 1rem;
}

.item-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 1rem;
}

.price-section {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
}

.item-price {
    color: #2d3748;
    font-size: 1.25rem;
    font-weight: 700;
}

.popular-badge {
    background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%);
    color: white;
    padding: 0.25rem 0.75rem;
    border-radius: 50px;
    font-size: 0.75rem;
    font-weight: 600;
}

.add-to-cart-section {
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.quantity-selector {
    display: flex;
    align-items: center;
    background: white;
    border: 2px solid #e2e8f0;
    border-radius: 12px;
    overflow: hidden;
}

.quantity-btn {
    background: none;
    border: none;
    padding: 0.5rem;
    color: #667eea;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
}

.quantity-btn:hover {
    background: #667eea;
    color: white;
}

.quantity-input {
    border: none;
    width: 50px;
    text-align: center;
    padding: 0.5rem 0;
    font-weight: 600;
    color: #2d3748;
    background: transparent;
}

.quantity-input:focus {
    outline: none;
}

.add-btn {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    padding: 0.75rem 1.5rem;
    border-radius: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
}

.add-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(102, 126, 234, 0.6);
}

.add-btn.success {
    background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
}

.empty-menu {
    background: white;
    border-radius: 20px;
    padding: 4rem 2rem;
    text-align: center;
    box-shadow: 0 10px 40px rgba(0,0,0,0.1);
}

.empty-icon {
    font-size: 4rem;
    color: #e2e8f0;
    margin-bottom: 1rem;
}

.empty-title {
    color: #2d3748;
    font-size: 1.5rem;
    font-weight: 600;
    margin-bottom: 1rem;
}

.empty-text {
    color: #718096;
    font-size: 1rem;
    line-height: 1.6;
}

@media (max-width: 768px) {
    .header-content {
        flex-direction: column;
        align-items: stretch;
    }
    
    .restaurant-title {
        font-size: 2rem;
        text-align: center;
    }
    
    .header-actions {
        justify-content: center;
    }
    
    .info-grid {
        grid-template-columns: 1fr;
    }
    
    .items-grid {
        grid-template-columns: 1fr;
    }
    
    .item-footer {
        flex-direction: column;
        align-items: stretch;
        gap: 1rem;
    }
    
    .add-to-cart-section {
        justify-content: space-between;
    }
}
</style>
{% endblock %}

{% block scripts %}
<script>
function addToCart(itemId, bookingId, restaurantId) {
    const quantityInput = document.getElementById(`qty-${itemId}`);
    const quantity = quantityInput.value;
    const btn = event.target.closest('.add-btn');
    
    // Show loading state
    const originalContent = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Adding...';
    btn.disabled = true;
    
    // Get CSRF token
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
    
    fetch('/food/add_to_cart', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRF-Token': csrfToken
        },
        body: `item_id=${itemId}&quantity=${quantity}&booking_id=${bookingId}&restaurant_id=${restaurantId}&csrf_token=${csrfToken}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update cart count
            const cartCount = document.getElementById('cart-count');
            if (cartCount) {
                cartCount.textContent = data.item_count;
                cartCount.style.display = data.item_count > 0 ? 'flex' : 'none';
            }
            
            // Show success state
            btn.innerHTML = '<i class="fas fa-check"></i> Added!';
            btn.classList.add('success');
            
            // Reset after 2 seconds
            setTimeout(() => {
                btn.innerHTML = originalContent;
                btn.classList.remove('success');
                btn.disabled = false;
            }, 2000);
        } else {
            // Show error
            btn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Error';
            setTimeout(() => {
                btn.innerHTML = originalContent;
                btn.disabled = false;
            }, 2000);
            console.error('Error:', data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        btn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Error';
        setTimeout(() => {
            btn.innerHTML = originalContent;
            btn.disabled = false;
        }, 2000);
    });
}

// Quantity selector functions
function decreaseQuantity(itemId) {
    const input = document.getElementById(`qty-${itemId}`);
    const currentValue = parseInt(input.value);
    if (currentValue > 1) {
        input.value = currentValue - 1;
    }
}

function increaseQuantity(itemId) {
    const input = document.getElementById(`qty-${itemId}`);
    const currentValue = parseInt(input.value);
    if (currentValue < 10) {
        input.value = currentValue + 1;
    }
}

// Initialize cart count on page load
document.addEventListener('DOMContentLoaded', function() {
    const cartCount = document.getElementById('cart-count');
    if (cartCount && cartCount.textContent === '0') {
        cartCount.style.display = 'none';
    }
});
</script>
{% endblock %}

{% block content %}
<div class="menu-container">
    <div class="content-wrapper">
        <!-- Menu Header -->
        <div class="menu-header">
            <div class="header-content">
                <h1 class="restaurant-title">
                    <i class="fas fa-utensils"></i>
                    {{ restaurant.name }}
                </h1>
                <div class="header-actions">
                    <a href="{{ url_for('food.view_cart', booking_id=booking.id, restaurant_id=restaurant.id) }}" 
                       class="cart-btn">
                        <i class="fas fa-shopping-cart"></i>
                        View Cart
                        <span class="cart-count" id="cart-count">0</span>
                    </a>
                    <a href="{{ url_for('food.restaurants_for_booking', booking_id=booking.id) }}" 
                       class="back-btn">
                        <i class="fas fa-arrow-left"></i>
                        Back
                    </a>
                </div>
            </div>
        </div>

        <!-- Restaurant Info -->
        <div class="restaurant-info-card">
            <div class="info-grid">
                <div class="info-section">
                    <h5><i class="fas fa-store"></i>Restaurant Info</h5>
                    <div class="info-item">
                        <span class="info-label">Location</span>
                        <span class="info-value">{{ restaurant.station.name }} Station</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Cuisine Type</span>
                        <span class="info-value">{{ restaurant.cuisine_type }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Rating</span>
                        <span class="info-value">
                            <span class="rating-stars">
                                {% for i in range(restaurant.rating|int) %}★{% endfor %}
                            </span>
                            {{ "%.1f"|format(restaurant.rating) }}
                        </span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Delivery Time</span>
                        <span class="info-value">{{ restaurant.delivery_time }} minutes</span>
                    </div>
                </div>
                <div class="info-section">
                    <h5><i class="fas fa-ticket-alt"></i>Journey Details</h5>
                    <div class="info-item">
                        <span class="info-label">PNR</span>
                        <span class="info-value">{{ booking.pnr }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Train</span>
                        <span class="info-value">{{ booking.train.name }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Journey Date</span>
                        <span class="info-value">{{ booking.journey_date.strftime('%d %b %Y') }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Route</span>
                        <span class="info-value">{{ booking.from_station.code }} → {{ booking.to_station.code }}</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Delivery Info Alert -->
        {% if restaurant.minimum_order > 0 or restaurant.delivery_charge > 0 %}
        <div class="delivery-alert">
            <p class="alert-content">
                <i class="fas fa-info-circle" style="margin-right: 0.5rem;"></i>
                {% if restaurant.minimum_order > 0 %}
                    Minimum order: ₹{{ "%.0f"|format(restaurant.minimum_order) }}
                {% endif %}
                {% if restaurant.delivery_charge > 0 %}
                    {% if restaurant.minimum_order > 0 %} | {% endif %}
                    Delivery charges: ₹{{ "%.0f"|format(restaurant.delivery_charge) }}
                {% endif %}
            </p>
        </div>
        {% endif %}

        <!-- Menu Categories -->
        {% if menu_by_category %}
        <div class="menu-categories">
            {% for category, items in menu_by_category.items() %}
            <div class="category-section">
                <h2 class="category-header">{{ category }}</h2>
                <div class="category-items">
                    <div class="items-grid">
                        {% for item in items %}
                        <div class="menu-item-card">
                            <div class="item-header">
                                <h3 class="item-name">{{ item.name }}</h3>
                                {% if item.food_type == 'Vegetarian' %}
                                    <span class="food-type-badge veg-badge">
                                        🌱 Veg
                                    </span>
                                {% else %}
                                    <span class="food-type-badge non-veg-badge">
                                        🍖 Non-Veg
                                    </span>
                                {% endif %}
                            </div>
                            
                            {% if item.description %}
                            <p class="item-description">
                                {{ item.description[:150] }}{% if item.description|length > 150 %}...{% endif %}
                            </p>
                            {% endif %}
                            
                            <div class="item-footer">
                                <div class="price-section">
                                    <span class="item-price">₹{{ "%.0f"|format(item.price) }}</span>
                                    {% if item.is_popular %}
                                        <span class="popular-badge">Popular</span>
                                    {% endif %}
                                </div>
                                
                                <div class="add-to-cart-section">
                                    <div class="quantity-selector">
                                        <button type="button" class="quantity-btn" onclick="decreaseQuantity({{ item.id }})">−</button>
                                        <input type="number" class="quantity-input" 
                                               id="qty-{{ item.id }}" value="1" min="1" max="10" readonly>
                                        <button type="button" class="quantity-btn" onclick="increaseQuantity({{ item.id }})">+</button>
                                    </div>
                                    <button class="add-btn" onclick="addToCart({{ item.id }}, {{ booking.id }}, {{ restaurant.id }})">
                                        <i class="fas fa-plus"></i>
                                        Add
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="empty-menu">
            <div class="empty-icon">
                <i class="fas fa-utensils"></i>
            </div>
            <h3 class="empty-title">Menu Not Available</h3>
            <p class="empty-text">
                No menu items are currently available at this restaurant.<br>
                Please try again later or contact the restaurant directly.
            </p>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}
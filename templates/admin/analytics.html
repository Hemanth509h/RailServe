{% extends "base.html" %}

{% block title %}Analytics - Admin - RailServe{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/modern-design.css') }}">
<style>
.analytics-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: var(--space-6);
    background: var(--secondary-50);
    min-height: 100vh;
}

.admin-header.modern-header {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    color: var(--primary-700);
    padding: 48px;
    border-radius: 24px;
    margin-bottom: 40px;
    box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: var(--space-6);
    position: relative;
    transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
}

.admin-header.modern-header::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    opacity: 0.1;
    border-radius: 24px;
    z-index: -1;
}

.header-content {
    text-align: center;
    flex: 1;
}

.header-subtitle {
    color: var(--secondary-600);
    font-size: 1.1rem;
    margin: 8px 0 0 0;
    font-weight: 500;
}

.admin-header h1 {
    margin: 0;
    font-size: 2.5rem;
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: var(--space-3);
}

.btn {
    padding: var(--space-3) var(--space-5);
    border-radius: var(--radius-lg);
    text-decoration: none;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    gap: var(--space-2);
    transition: all 0.2s ease;
    border: none;
    cursor: pointer;
}

.btn-secondary {
    background: rgba(0, 0, 0, 0.1);
    color: white;
    border: 2px solid rgba(255, 255, 255, 0.2);
}

.btn-secondary:hover {
    background: rgba(0, 0, 0, 0.2);
    transform: translateY(-1px);
}

.analytics-filters {
    margin-bottom: var(--space-6);
}

.filter-card {
    background: white;
    border-radius: var(--radius-xl);
    padding: var(--space-6);
    box-shadow: var(--shadow-md);
    border: 1px solid var(--secondary-200);
}

.filter-card h3 {
    margin: 0 0 var(--space-4) 0;
    color: var(--secondary-800);
    font-size: 1.25rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: var(--space-2);
}

.filter-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: var(--space-4);
}

.filter-group {
    display: flex;
    flex-direction: column;
    gap: var(--space-2);
}

.filter-group label {
    font-weight: 600;
    color: var(--secondary-700);
    font-size: 0.875rem;
}

.filter-group select,
.filter-group input {
    padding: var(--space-3);
    border: 2px solid var(--secondary-200);
    border-radius: var(--radius-lg);
    background: white;
    color: var(--secondary-800);
    font-size: 1rem;
}

.analytics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: var(--space-6);
}

.analytics-card {
    background: white;
    border-radius: var(--radius-xl);
    padding: var(--space-6);
    box-shadow: var(--shadow-md);
    border: 1px solid var(--secondary-200);
}

.analytics-card h3 {
    margin: 0 0 var(--space-4) 0;
    color: var(--secondary-800);
    font-size: 1.25rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: var(--space-2);
}

.chart-container {
    height: 300px;
    position: relative;
}

.chart-container canvas {
    width: 100% !important;
    height: 100% !important;
}

@media (max-width: 768px) {
    .analytics-container {
        padding: var(--space-4);
    }
    
    .admin-header {
        flex-direction: column;
        text-align: center;
    }
    
    .admin-header h1 {
        font-size: 2rem;
    }
    
    .analytics-grid {
        grid-template-columns: 1fr;
    }
    
    .filter-row {
        grid-template-columns: 1fr;
    }
}

@media (prefers-reduced-motion: reduce) {
    .btn {
        transition: none;
    }
    
    .btn:hover {
        transform: none;
    }
}
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<div class="analytics-container">
    <div class="admin-header modern-header">
        <a href="{{ url_for('admin.dashboard') }}" class="back-button">
            <i class="fas fa-arrow-left"></i>
            Dashboard
        </a>
        <div class="header-content">
            <h1><i class="fas fa-chart-line"></i> Analytics Dashboard</h1>
            <p class="header-subtitle">Real-time insights and performance metrics</p>
        </div>
        <div class="header-actions">
            <button onclick="exportAllCharts()" class="btn modern-btn primary">
                <i class="fas fa-download"></i>
                Export All
            </button>
            <button onclick="refreshAnalytics()" class="btn modern-btn secondary">
                <i class="fas fa-sync-alt"></i>
                Refresh
            </button>
        </div>
    </div>
    
    <div class="analytics-filters">
        <div class="filter-card">
            <h3><i class="fas fa-filter"></i> Filter Analytics</h3>
            <form method="GET" class="filter-form">
                <div class="filter-row">
                    <div class="filter-group">
                        <label for="date_range">Date Range</label>
                        <select id="date_range" name="date_range" onchange="this.form.submit()">
                            <option value="7" {{ 'selected' if request.args.get('date_range') == '7' }}>Last 7 Days</option>
                            <option value="30" {{ 'selected' if request.args.get('date_range', '30') == '30' }}>Last 30 Days</option>
                            <option value="90" {{ 'selected' if request.args.get('date_range') == '90' }}>Last 90 Days</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label for="train_search">Search Trains</label>
                        <input type="text" id="train_search" name="train_search" placeholder="Search by train number/name..." 
                               value="{{ request.args.get('train_search', '') }}" onchange="this.form.submit()">
                    </div>
                    
                    <div class="filter-group">
                        <label for="booking_type">Booking Type</label>
                        <select id="booking_type" name="booking_type" onchange="this.form.submit()">
                            <option value="">All Types</option>
                            <option value="general" {{ 'selected' if request.args.get('booking_type') == 'general' }}>General</option>
                            <option value="tatkal" {{ 'selected' if request.args.get('booking_type') == 'tatkal' }}>Tatkal</option>
                        </select>
                    </div>
                </div>
            </form>
        </div>
    </div>
    
    <div class="analytics-grid">
        <div class="analytics-card">
            <h3><i class="fas fa-rupee-sign"></i> Revenue Trends (Last 30 Days)</h3>
            <div class="chart-container">
                <canvas id="revenueChart"></canvas>
            </div>
        </div>
        
        <div class="analytics-card">
            <h3><i class="fas fa-chart-pie"></i> Booking Distribution</h3>
            <div class="chart-container">
                <canvas id="bookingStatusChart"></canvas>
            </div>
        </div>
        
        <div class="analytics-card">
            <h3><i class="fas fa-train"></i> Popular Trains</h3>
            <div class="chart-container">
                <canvas id="popularTrainsChart"></canvas>
            </div>
        </div>
        
        <div class="analytics-card">
            <h3><i class="fas fa-calendar"></i> Booking Trends</h3>
            <div class="chart-container">
                <canvas id="bookingTrendsChart"></canvas>
            </div>
        </div>
    </div>
    
    <div class="analytics-card">
        <h3><i class="fas fa-table"></i> Detailed Metrics</h3>
        
        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-icon">
                    <i class="fas fa-chart-line"></i>
                </div>
                <div class="metric-content">
                    <h4>Average Booking Value</h4>
                    <div class="metric-value">
                        {% set total_amount = daily_revenue|sum(attribute=1) %}
                        {% set total_bookings = booking_trends|sum(attribute=1) %}
                        â‚¹{{ "%.2f"|format((total_amount / total_bookings) if total_bookings > 0 else 0) }}
                    </div>
                </div>
            </div>
            
            <div class="metric-card">
                <div class="metric-icon">
                    <i class="fas fa-percentage"></i>
                </div>
                <div class="metric-content">
                    <h4>Booking Success Rate</h4>
                    <div class="metric-value">
                        {% set confirmed_count = 0 %}
                        {% set total_count = 0 %}
                        {% for status, count in booking_stats %}
                            {% if status == 'confirmed' %}
                                {% set confirmed_count = count %}
                            {% endif %}
                            {% set total_count = total_count + count %}
                        {% endfor %}
                        {{ "%.1f"|format((confirmed_count / total_count * 100) if total_count > 0 else 0) }}%
                    </div>
                </div>
            </div>
            
            <div class="metric-card">
                <div class="metric-icon">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="metric-content">
                    <h4>Waitlist Conversion</h4>
                    <div class="metric-value">
                        {% set waitlisted_count = 0 %}
                        {% for status, count in booking_stats %}
                            {% if status == 'waitlisted' %}
                                {% set waitlisted_count = count %}
                            {% endif %}
                        {% endfor %}
                        {{ "%.1f"|format((waitlisted_count / total_count * 100) if total_count > 0 else 0) }}%
                    </div>
                </div>
            </div>
            
            <div class="metric-card">
                <div class="metric-icon">
                    <i class="fas fa-calendar-day"></i>
                </div>
                <div class="metric-content">
                    <h4>Daily Average Bookings</h4>
                    <div class="metric-value">
                        {{ "%.1f"|format((booking_trends|sum(attribute=1) / booking_trends|length) if booking_trends|length > 0 else 0) }}
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="analytics-card">
        <h3><i class="fas fa-download"></i> Export Options</h3>
        
        <div class="export-options">
            <a href="{{ url_for('admin.export_bookings') }}" class="btn btn-primary">
                <i class="fas fa-file-csv"></i> Download Booking Report (CSV)
            </a>
            
            <button onclick="exportChart('revenueChart')" class="btn btn-secondary">
                <i class="fas fa-image"></i> Export Revenue Chart
            </button>
            
            <button onclick="exportChart('popularTrainsChart')" class="btn btn-secondary">
                <i class="fas fa-image"></i> Export Popular Trains Chart
            </button>
        </div>
    </div>
</div>
{% endblock %}


{% block scripts %}
<script>
// RailServe Analytics Charts - Chart.js Implementation

// Chart.js Configuration and Initialization
let charts = {};

// Initialize all analytics charts
function initializeAnalyticsCharts(revenueData, bookingStatusData, popularTrainsData, bookingTrendsData) {
    // Initialize Revenue Chart
    initializeRevenueChart(revenueData);
    
    // Initialize Booking Status Chart
    initializeBookingStatusChart(bookingStatusData);
    
    // Initialize Popular Trains Chart
    initializePopularTrainsChart(popularTrainsData);
    
    // Initialize Booking Trends Chart
    initializeBookingTrendsChart(bookingTrendsData);
}

// Revenue Chart (Line Chart)
function initializeRevenueChart(data) {
    const ctx = document.getElementById('revenueChart');
    if (!ctx) return;
    
    charts.revenue = new Chart(ctx, {
        type: 'line',
        data: data,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'Daily Revenue Trends',
                    font: {
                        size: 16,
                        weight: 'bold'
                    }
                },
                legend: {
                    display: false
                },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    titleColor: 'white',
                    bodyColor: 'white',
                    borderColor: '#3b82f6',
                    borderWidth: 1,
                    callbacks: {
                        label: function(context) {
                            return 'Revenue: â‚¹' + context.parsed.y.toLocaleString('en-IN', {
                                minimumFractionDigits: 2,
                                maximumFractionDigits: 2
                            });
                        }
                    }
                }
            },
            scales: {
                x: {
                    display: true,
                    title: {
                        display: true,
                        text: 'Date',
                        font: {
                            weight: 'bold'
                        }
                    },
                    grid: {
                        display: false
                    }
                },
                y: {
                    display: true,
                    title: {
                        display: true,
                        text: 'Revenue (â‚¹)',
                        font: {
                            weight: 'bold'
                        }
                    },
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return 'â‚¹' + value.toLocaleString('en-IN');
                        }
                    }
                }
            },
            elements: {
                point: {
                    radius: 4,
                    hoverRadius: 6,
                    backgroundColor: '#3b82f6',
                    borderColor: '#ffffff',
                    borderWidth: 2
                },
                line: {
                    tension: 0.4,
                    borderWidth: 3,
                    fill: true
                }
            },
            interaction: {
                intersect: false,
                mode: 'index'
            }
        }
    });
}

// Booking Status Chart (Doughnut Chart)
function initializeBookingStatusChart(data) {
    const ctx = document.getElementById('bookingStatusChart');
    if (!ctx) return;
    
    charts.bookingStatus = new Chart(ctx, {
        type: 'doughnut',
        data: data,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'Booking Status Distribution',
                    font: {
                        size: 16,
                        weight: 'bold'
                    }
                },
                legend: {
                    display: true,
                    position: 'bottom',
                    labels: {
                        padding: 20,
                        usePointStyle: true,
                        font: {
                            size: 12
                        }
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    titleColor: 'white',
                    bodyColor: 'white',
                    borderColor: '#3b82f6',
                    borderWidth: 1,
                    callbacks: {
                        label: function(context) {
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((context.parsed * 100) / total).toFixed(1);
                            return context.label + ': ' + context.parsed + ' (' + percentage + '%)';
                        }
                    }
                }
            },
            cutout: '50%',
            elements: {
                arc: {
                    borderWidth: 2,
                    borderColor: '#ffffff'
                }
            }
        }
    });
}

// Popular Trains Chart (Horizontal Bar Chart)
function initializePopularTrainsChart(data) {
    const ctx = document.getElementById('popularTrainsChart');
    if (!ctx) return;
    
    charts.popularTrains = new Chart(ctx, {
        type: 'bar',
        data: data,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y',
            plugins: {
                title: {
                    display: true,
                    text: 'Most Popular Trains',
                    font: {
                        size: 16,
                        weight: 'bold'
                    }
                },
                legend: {
                    display: false
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    titleColor: 'white',
                    bodyColor: 'white',
                    borderColor: '#8b5cf6',
                    borderWidth: 1,
                    callbacks: {
                        label: function(context) {
                            return 'Bookings: ' + context.parsed.x;
                        }
                    }
                }
            },
            scales: {
                x: {
                    display: true,
                    title: {
                        display: true,
                        text: 'Number of Bookings',
                        font: {
                            weight: 'bold'
                        }
                    },
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                },
                y: {
                    display: true,
                    title: {
                        display: true,
                        text: 'Train Name',
                        font: {
                            weight: 'bold'
                        }
                    },
                    ticks: {
                        font: {
                            size: 10
                        }
                    }
                }
            },
            elements: {
                bar: {
                    borderRadius: 4,
                    borderSkipped: false
                }
            }
        }
    });
}

// Booking Trends Chart (Area Chart)
function initializeBookingTrendsChart(data) {
    const ctx = document.getElementById('bookingTrendsChart');
    if (!ctx) return;
    
    charts.bookingTrends = new Chart(ctx, {
        type: 'line',
        data: data,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'Booking Trends (Last 30 Days)',
                    font: {
                        size: 16,
                        weight: 'bold'
                    }
                },
                legend: {
                    display: false
                },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    titleColor: 'white',
                    bodyColor: 'white',
                    borderColor: '#059669',
                    borderWidth: 1,
                    callbacks: {
                        label: function(context) {
                            return 'Bookings: ' + context.parsed.y;
                        }
                    }
                },
                filler: {
                    propagate: true
                }
            },
            scales: {
                x: {
                    display: true,
                    title: {
                        display: true,
                        text: 'Date',
                        font: {
                            weight: 'bold'
                        }
                    },
                    grid: {
                        display: false
                    }
                },
                y: {
                    display: true,
                    title: {
                        display: true,
                        text: 'Number of Bookings',
                        font: {
                            weight: 'bold'
                        }
                    },
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            },
            elements: {
                point: {
                    radius: 3,
                    hoverRadius: 5,
                    backgroundColor: '#059669',
                    borderColor: '#ffffff',
                    borderWidth: 2
                },
                line: {
                    tension: 0.4,
                    borderWidth: 3,
                    fill: true
                }
            },
            interaction: {
                intersect: false,
                mode: 'index'
            }
        }
    });
}

// Utility function to update chart data
function updateChart(chartName, newData) {
    if (charts[chartName]) {
        charts[chartName].data = newData;
        charts[chartName].update('active');
    }
}

// Utility function to export chart as image
function exportChart(chartId) {
    const chart = charts[chartId.replace('Chart', '')];
    if (chart) {
        const canvas = chart.canvas;
        const link = document.createElement('a');
        link.download = chartId + '-export.png';
        link.href = canvas.toDataURL('image/png');
        link.click();
    }
}

// Responsive chart resize handler
function handleChartResize() {
    Object.values(charts).forEach(chart => {
        chart.resize();
    });
}

// Initialize resize listener
window.addEventListener('resize', debounce(handleChartResize, 300));

// Chart color palettes
const colorPalettes = {
    primary: ['#3b82f6', '#1d4ed8', '#1e40af', '#1e3a8a'],
    success: ['#10b981', '#059669', '#047857', '#065f46'],
    warning: ['#f59e0b', '#d97706', '#b45309', '#92400e'],
    danger: ['#ef4444', '#dc2626', '#b91c1c', '#991b1b'],
    info: ['#06b6d4', '#0891b2', '#0e7490', '#155e75'],
    purple: ['#8b5cf6', '#7c3aed', '#6d28d9', '#5b21b6'],
    mixed: ['#10b981', '#f59e0b', '#ef4444', '#6b7280', '#3b82f6', '#8b5cf6']
};

// Function to get color palette
function getColorPalette(name = 'mixed', count = null) {
    const palette = colorPalettes[name] || colorPalettes.mixed;
    return count ? palette.slice(0, count) : palette;
}

// Chart animation configurations
const animationConfigs = {
    default: {
        duration: 2000,
        easing: 'easeInOutQuart'
    },
    fast: {
        duration: 1000,
        easing: 'easeOutQuart'
    },
    slow: {
        duration: 3000,
        easing: 'easeInOutQuint'
    }
};

// Debounce utility function
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// Export functions for global use
window.ChartManager = {
    initializeAnalyticsCharts,
    updateChart,
    exportChart,
    handleChartResize,
    getColorPalette
};

// Initialize charts when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    // Add Chart.js error handling
    Chart.defaults.plugins.tooltip.enabled = true;
    Chart.defaults.animation = animationConfigs.default;
    
    // Set global font family
    Chart.defaults.font.family = "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif";
    
    console.log('Chart.js manager initialized');
});
</script>
<script>
    // Prepare data for charts with safe fallbacks
    const revenueData = {
        labels: [
            {% if daily_revenue %}
                {% for date, amount in daily_revenue %}
                    '{{ date.strftime("%d %b") if date else "N/A" }}',
                {% endfor %}
            {% else %}
                'No Data'
            {% endif %}
        ],
        datasets: [{
            label: 'Revenue (â‚¹)',
            data: [
                {% if daily_revenue %}
                    {% for date, amount in daily_revenue %}
                        {{ amount or 0 }},
                    {% endfor %}
                {% else %}
                    0
                {% endif %}
            ],
            borderColor: '#2563eb',
            backgroundColor: 'rgba(37, 99, 235, 0.1)',
            tension: 0.4
        }]
    };
    
    const bookingStatusData = {
        labels: [
            {% if booking_stats %}
                {% for status, count in booking_stats %}
                    '{{ status.replace("_", " ").title() }}',
                {% endfor %}
            {% else %}
                'No Bookings'
            {% endif %}
        ],
        datasets: [{
            data: [
                {% if booking_stats %}
                    {% for status, count in booking_stats %}
                        {{ count }},
                    {% endfor %}
                {% else %}
                    0
                {% endif %}
            ],
            backgroundColor: [
                '#10b981', // confirmed - green
                '#f59e0b', // waitlisted - amber
                '#ef4444', // cancelled - red
                '#6b7280'  // pending_payment - gray
            ]
        }]
    };
    
    const popularTrainsData = {
        labels: [
            {% if popular_trains %}
                {% for train_name, count in popular_trains %}
                    '{{ train_name[:20] }}{{ "..." if train_name|length > 20 else "" }}',
                {% endfor %}
            {% else %}
                'No Trains'
            {% endif %}
        ],
        datasets: [{
            label: 'Bookings',
            data: [
                {% if popular_trains %}
                    {% for train_name, count in popular_trains %}
                        {{ count }},
                    {% endfor %}
                {% else %}
                    0
                {% endif %}
            ],
            backgroundColor: '#8b5cf6'
        }]
    };
    
    const bookingTrendsData = {
        labels: [
            {% if booking_trends %}
                {% for date, count in booking_trends %}
                    '{{ date.strftime("%d %b") if date else "N/A" }}',
                {% endfor %}
            {% else %}
                'No Data'
            {% endif %}
        ],
        datasets: [{
            label: 'Bookings',
            data: [
                {% if booking_trends %}
                    {% for date, count in booking_trends %}
                        {{ count }},
                    {% endfor %}
                {% else %}
                    0
                {% endif %}
            ],
            borderColor: '#059669',
            backgroundColor: 'rgba(5, 150, 105, 0.1)',
            tension: 0.4
        }]
    };
    
    // Initialize charts
    document.addEventListener('DOMContentLoaded', function() {
        initializeAnalyticsCharts(revenueData, bookingStatusData, popularTrainsData, bookingTrendsData);
    });
    
    function exportChart(chartId) {
        const canvas = document.getElementById(chartId);
        const link = document.createElement('a');
        link.download = chartId + '-chart.png';
        link.href = canvas.toDataURL();
        link.click();
    }
</script>
{% endblock %}

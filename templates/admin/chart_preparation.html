{% extends "base.html" %}

{% block title %}Chart Preparation - Admin{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}">
<style>
.chart-section {
    margin-bottom: 2rem;
}

.chart-card {
    background: white;
    border-radius: 8px;
    padding: 1.5rem;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    margin-bottom: 1rem;
}

.chart-header {
    display: flex;
    justify-content: between;
    align-items: center;
    margin-bottom: 1rem;
}

.chart-status {
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.875rem;
    font-weight: 500;
}

.status-prepared {
    background-color: #e7f3ff;
    color: #0066cc;
}

.status-final {
    background-color: #e7ffe7;
    color: #00cc00;
}

.status-pending {
    background-color: #fff3e0;
    color: #ff9800;
}

.chart-actions {
    display: flex;
    gap: 0.5rem;
}

.btn-prepare, .btn-finalize {
    padding: 0.5rem 1rem;
    border: none;
    border-radius: 4px;
    text-decoration: none;
    font-size: 0.875rem;
    cursor: pointer;
}

.btn-prepare {
    background-color: #007bff;
    color: white;
}

.btn-finalize {
    background-color: #28a745;
    color: white;
}

.btn-prepare:hover {
    background-color: #0056b3;
    text-decoration: none;
    color: white;
}

.btn-finalize:hover {
    background-color: #1e7e34;
    text-decoration: none;
    color: white;
}

.train-info {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
}

.train-number {
    font-weight: bold;
    color: #333;
}

.train-name {
    color: #666;
    font-size: 0.875rem;
}

/* Search and Filter Styles */
.search-section {
    background: white;
    border-radius: 8px;
    padding: 1.5rem;
    margin-bottom: 2rem;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.search-controls {
    display: flex;
    gap: 1rem;
    align-items: center;
    flex-wrap: wrap;
}

.search-input-group {
    display: flex;
    gap: 0.5rem;
    flex: 1;
    min-width: 300px;
}

.search-input {
    flex: 1;
    padding: 0.75rem;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-size: 0.9rem;
}

.search-btn, .filter-btn {
    padding: 0.75rem 1.5rem;
    background-color: #007bff;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.9rem;
    transition: background-color 0.2s;
}

.search-btn:hover, .filter-btn:hover {
    background-color: #0056b3;
}

.filter-group {
    display: flex;
    gap: 0.5rem;
    align-items: center;
}

.filter-select {
    padding: 0.75rem;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-size: 0.9rem;
}

.clear-filters-btn {
    padding: 0.75rem 1rem;
    background-color: #6c757d;
    color: white;
    text-decoration: none;
    border-radius: 6px;
    font-size: 0.9rem;
    transition: background-color 0.2s;
}

.clear-filters-btn:hover {
    background-color: #545b62;
    text-decoration: none;
    color: white;
}

@media (max-width: 768px) {
    .search-controls {
        flex-direction: column;
        align-items: stretch;
    }
    
    .search-input-group {
        min-width: 100%;
    }
    
    .filter-group {
        justify-content: space-between;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="admin-container">
    <div class="admin-header">
        <h1><i class="fas fa-clipboard-list"></i> Chart Preparation</h1>
        <p>Manage chart preparation and seat assignments for trains</p>
    </div>

    <!-- Search and Filter Controls -->
    <div class="search-section">
        <form method="GET" class="search-form">
            <div class="search-controls">
                <div class="search-input-group">
                    <input type="text" name="search" placeholder="Search by train number or name..." 
                           value="{{ search or '' }}" class="search-input">
                    <button type="submit" class="search-btn">
                        <i class="fas fa-search"></i> Search
                    </button>
                </div>
                <div class="filter-group">
                    <select name="status" class="filter-select">
                        <option value="">All Statuses</option>
                        <option value="prepared" {% if status_filter == 'prepared' %}selected{% endif %}>Prepared</option>
                        <option value="final" {% if status_filter == 'final' %}selected{% endif %}>Final</option>
                        <option value="pending" {% if status_filter == 'pending' %}selected{% endif %}>Pending</option>
                    </select>
                    <button type="submit" class="filter-btn">
                        <i class="fas fa-filter"></i> Filter
                    </button>
                </div>
                {% if search or status_filter %}
                    <a href="{{ url_for('admin.chart_preparation') }}" class="clear-filters-btn">
                        <i class="fas fa-times"></i> Clear Filters
                    </a>
                {% endif %}
            </div>
        </form>
    </div>

    <div class="chart-section">
        <h2><i class="fas fa-calendar-day"></i> Today's Charts ({{ today }})</h2>
        {% if charts_today %}
            {% for chart, train in charts_today %}
                <div class="chart-card">
                    <div class="chart-header">
                        <div class="train-info">
                            <div class="train-number">{{ train.number }} - {{ train.name }}</div>
                            <div class="train-name">
                                Journey Date: {{ chart.journey_date.strftime('%Y-%m-%d') }}
                            </div>
                        </div>
                        <div>
                            <span class="chart-status status-{{ chart.status }}">
                                {{ chart.status.title() }}
                            </span>
                        </div>
                    </div>
                    <div class="chart-details">
                        <p><strong>Chart Prepared:</strong> 
                            {% if chart.chart_prepared_at %}
                                {{ chart.chart_prepared_at.strftime('%Y-%m-%d %H:%M:%S') }}
                            {% else %}
                                Not prepared
                            {% endif %}
                        </p>
                        {% if chart.final_chart_at %}
                            <p><strong>Final Chart:</strong> {{ chart.final_chart_at.strftime('%Y-%m-%d %H:%M:%S') }}</p>
                        {% endif %}
                        <p><strong>Confirmed from Waitlist:</strong> {{ chart.confirmed_from_waitlist or 0 }}</p>
                        <p><strong>Cancelled Waitlist:</strong> {{ chart.cancelled_waitlist or 0 }}</p>
                    </div>
                    <div class="chart-actions">
                        {% if chart.status != 'final' %}
                            <a href="{{ url_for('admin.finalize_chart_manual', train_id=train.id, journey_date=chart.journey_date.strftime('%Y-%m-%d')) }}" 
                               class="btn-finalize">
                                <i class="fas fa-check"></i> Finalize Chart
                            </a>
                        {% endif %}
                    </div>
                </div>
            {% endfor %}
        {% else %}
            <div class="chart-card">
                <p>No charts prepared for today.</p>
            </div>
        {% endif %}
    </div>

    <div class="chart-section">
        <h2><i class="fas fa-calendar-plus"></i> Tomorrow's Charts ({{ tomorrow }})</h2>
        {% if charts_tomorrow %}
            {% for chart, train in charts_tomorrow %}
                <div class="chart-card">
                    <div class="chart-header">
                        <div class="train-info">
                            <div class="train-number">{{ train.number }} - {{ train.name }}</div>
                            <div class="train-name">
                                Journey Date: {{ chart.journey_date.strftime('%Y-%m-%d') }}
                            </div>
                        </div>
                        <div>
                            <span class="chart-status status-{{ chart.status }}">
                                {{ chart.status.title() }}
                            </span>
                        </div>
                    </div>
                    <div class="chart-details">
                        <p><strong>Chart Prepared:</strong> 
                            {% if chart.chart_prepared_at %}
                                {{ chart.chart_prepared_at.strftime('%Y-%m-%d %H:%M:%S') }}
                            {% else %}
                                Not prepared
                            {% endif %}
                        </p>
                        <p><strong>Confirmed from Waitlist:</strong> {{ chart.confirmed_from_waitlist or 0 }}</p>
                        <p><strong>Cancelled Waitlist:</strong> {{ chart.cancelled_waitlist or 0 }}</p>
                    </div>
                </div>
            {% endfor %}
        {% else %}
            <div class="chart-card">
                <p>No charts prepared for tomorrow.</p>
            </div>
        {% endif %}
    </div>

    <div class="chart-section">
        <h2><i class="fas fa-plus-circle"></i> Trains Needing Chart Preparation</h2>
        {% if trains_needing_charts %}
            {% for train in trains_needing_charts %}
                <div class="chart-card">
                    <div class="chart-header">
                        <div class="train-info">
                            <div class="train-number">{{ train.number }} - {{ train.name }}</div>
                            <div class="train-name">
                                Total Seats: {{ train.total_seats }} | Tatkal Seats: {{ train.tatkal_seats or 0 }}
                            </div>
                        </div>
                        <div>
                            <span class="chart-status status-pending">
                                Pending
                            </span>
                        </div>
                    </div>
                    <div class="chart-actions">
                        <a href="{{ url_for('admin.prepare_chart_manual', train_id=train.id, journey_date=today.strftime('%Y-%m-%d')) }}" 
                           class="btn-prepare">
                            <i class="fas fa-clipboard"></i> Prepare Today
                        </a>
                        <a href="{{ url_for('admin.prepare_chart_manual', train_id=train.id, journey_date=tomorrow.strftime('%Y-%m-%d')) }}" 
                           class="btn-prepare">
                            <i class="fas fa-clipboard"></i> Prepare Tomorrow
                        </a>
                    </div>
                </div>
            {% endfor %}
        {% else %}
            <div class="chart-card">
                <p>All active trains have charts prepared.</p>
            </div>
        {% endif %}
    </div>

    <div class="admin-actions">
        <a href="{{ url_for('admin.dashboard') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Back to Dashboard
        </a>
    </div>
</div>
{% endblock %}
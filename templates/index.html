{% extends "base.html" %}

{% block title %}RailServe - Find Your Train{% endblock %}

{% block head %}
<style>
    /* =================================================================
       BASE STYLES - Search Form (Desktop)
       ================================================================= */

    /* Main search form container */
    .search-form {
        background: var(--bg-secondary);
        padding: 2.5rem;
        border-radius: 16px;
        box-shadow: var(--card-shadow);
        margin-bottom: 2rem;
        max-width: 800px;
        margin: 0 auto 2rem auto;
        border: 1px solid var(--border-color);
    }

    .search-form .form-row {
        display: flex;
    }


    /* Station selection layout (From/To stations) */
    #form-select {
        display: flex;
        align-items: center;
        width: 100%;
        align-content: center;
    }

    /* Journey date and search button layout */
    #form-select2 {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
        align-items: end;
    }

    .search-form .form-group {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .search-form label {
        font-weight: 600;
        color: var(--text-primary);
        font-size: 0.9rem;
        letter-spacing: 0.3px;
    }

    .search-form select,
    .search-form input[type="date"] {
        padding: 0.875rem 1rem;
        border: 2px solid var(--border-color);
        border-radius: 10px;
        font-size: 1rem;
        transition: all 0.3s ease;
        background: var(--bg-primary);
        color: var(--text-primary);
        width: 100%;
    }

    .search-form select:focus,
    .search-form input[type="date"]:focus {
        outline: none;
        border-color: var(--accent-color);
        box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
    }

    /* Station swap button */
    .swap-btn {
        display: flex;
        align-items: flex-end;
        justify-content: center;
        padding-bottom: 0.25rem;
    }

    .swap-btn button {
        width: 44px;
        height: 44px;
        border: 2px solid var(--border-color);
        border-radius: 50%;
        background: var(--bg-primary);
        color: var(--text-secondary);
        font-size: 16px;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .swap-btn button:hover {
        background: var(--accent-color);
        color: white;
        border-color: var(--accent-color);
        transform: rotate(180deg);
    }

    /* Search button styling */
    .search-form .btn {
        padding: 0.875rem 2rem;
        background: linear-gradient(135deg, #3b82f6, #1d4ed8);
        color: white;
        border: none;
        border-radius: 10px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        width: 100%;
    }

    .search-form .btn:hover {
        background: linear-gradient(135deg, #1d4ed8, #1e40af);
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
    }

    /* =================================================================
       BASE STYLES - Universal Search Filter
       ================================================================= */

    .search-filters {
        display: grid;
        grid-template-columns: 2fr 1fr auto;
        gap: 15px;
        align-items: end;
        background: white;
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        margin-bottom: 30px;
    }

    .search-filters .form-group {
        display: flex;
        flex-direction: column;
    }

    .search-filters label {
        font-weight: 600;
        color: #374151;
        margin-bottom: 6px;
        font-size: 14px;
    }

    .search-filters input,
    .search-filters select {
        padding: 10px 14px;
        border: 2px solid #e5e7eb;
        border-radius: 6px;
        font-size: 15px;
        transition: all 0.2s ease;
    }

    .search-filters input:focus,
    .search-filters select:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .search-btn {
        padding: 10px 20px;
        background: #3b82f6;
        color: white;
        border: none;
        border-radius: 6px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .search-btn:hover {
        background: #1d4ed8;
        transform: translateY(-1px);
    }

    /* =================================================================
       BASE STYLES - Train Cards & Grid
       ================================================================= */

    .train-card {
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 16px;
        padding: 1.5rem;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        transition: all 0.3s ease;
        width: 100%;
        max-width: 550px;
    }
    
    .train-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
    }
    
    /* Seat Availability Styles - Professional Railway Booking Design */
    .seat-availability-section {
        margin: 1rem 0;
        background: var(--bg-primary);
        border-radius: 8px;
        border: 1px solid var(--border-color);
        overflow: hidden;
    }
    
    .availability-header {
        background: linear-gradient(135deg, #2c3e50, #34495e);
        color: white;
        padding: 0.75rem 1rem;
        font-weight: 600;
        font-size: 0.9rem;
        border-bottom: 2px solid #e74c3c;
    }
    
    .availability-table {
        width: 100%;
        border-collapse: collapse;
        background: var(--bg-secondary);
    }
    
    .availability-table thead {
        background: #ecf0f1;
    }
    
    .availability-table thead th {
        padding: 0.6rem 0.75rem;
        text-align: left;
        font-size: 0.75rem;
        font-weight: 700;
        color: #2c3e50;
        text-transform: uppercase;
        border-bottom: 2px solid #bdc3c7;
    }
    
    .availability-table tbody tr {
        border-bottom: 1px solid var(--border-color);
        transition: background 0.2s ease;
    }
    
    .availability-table tbody tr:hover {
        background: rgba(52, 152, 219, 0.05);
    }
    
    .availability-table tbody tr.row-available {
        border-left: 3px solid #27ae60;
    }
    
    .availability-table tbody tr.row-rac {
        border-left: 3px solid #f39c12;
    }
    
    .availability-table tbody tr.row-waitlist {
        border-left: 3px solid #e74c3c;
    }
    
    .availability-table td {
        padding: 0.65rem 0.75rem;
        font-size: 0.8rem;
        color: var(--text-primary);
    }
    
    .availability-table .class-code {
        font-weight: 700;
        font-size: 0.85rem;
        color: #2c3e50;
        font-family: monospace;
    }
    
    .availability-table .class-type {
        color: #7f8c8d;
        font-size: 0.75rem;
    }
    
    .availability-table .fare-mult {
        color: #95a5a6;
        font-size: 0.75rem;
        font-weight: 600;
    }
    
    .availability-cell {
        text-align: right;
    }
    
    .avail-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        padding: 0.3rem 0.6rem;
        border-radius: 4px;
        font-size: 0.7rem;
        font-weight: 700;
        font-family: monospace;
        letter-spacing: 0.5px;
    }
    
    .avail-badge i {
        font-size: 0.7rem;
    }
    
    .badge-available {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }
    
    .badge-rac {
        background: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
    }
    
    .badge-waitlist {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }
    
    .availability-footer {
        display: flex;
        gap: 1rem;
        padding: 0.6rem 1rem;
        background: #f8f9fa;
        border-top: 1px solid var(--border-color);
        justify-content: center;
        flex-wrap: wrap;
    }
    
    .legend-item {
        display: flex;
        align-items: center;
        gap: 0.4rem;
        font-size: 0.7rem;
        color: #7f8c8d;
    }
    
    .legend-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        display: inline-block;
    }
    
    .dot-available {
        background: #27ae60;
    }
    
    .dot-rac {
        background: #f39c12;
    }
    
    .dot-waitlist {
        background: #e74c3c;
    }

    .trains-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(min(100%, 500px), 1fr));
        gap: 2rem;
        margin-top: 2rem;
    }
    
    @media (max-width: 1200px) {
        .trains-grid {
            grid-template-columns: repeat(auto-fill, minmax(min(100%, 450px), 1fr));
            gap: 1.5rem;
        }
    }
    
    @media (max-width: 768px) {
        .trains-grid {
            grid-template-columns: 1fr;
            gap: 1.5rem;
        }
        
        .train-card {
            max-width: 100%;
        }
        
        /* Make seat availability table responsive on mobile */
        .availability-table {
            font-size: 0.75rem;
        }
        
        .availability-table thead th,
        .availability-table td {
            padding: 0.5rem 0.4rem;
        }
        
        .avail-badge {
            font-size: 0.65rem;
            padding: 0.25rem 0.4rem;
        }
    }

    /* =================================================================
       RESPONSIVE DESIGN - Tablet & Mobile (768px and below)
       ================================================================= */

    @media (max-width: 768px) {
        /* Search form adjustments for mobile */
        .search-form {
            padding: 1.5rem;
            margin: 0 0.5rem;
            width: calc(100% - 1rem);
        }

        /* Station selection - stack vertically on mobile */
        #form-select {
            display: flex;
            align-items: stretch;
            width: 100%;
            flex-direction: column;
            gap: 0px;
        }

        /* Journey date and button - stack vertically on mobile */
        #form-select2 {
            margin-top: 1rem;
            display: flex;
            flex-direction: column;
            grid-template-columns: 1fr;
            width: 100%;
            gap: 0px;
            
            align-items: stretch;
            height: auto;
        }

        /* Hero text spacing adjustment */
        p.lead.animate-fade-in-up {
            margin-bottom: 1rem;
        }

        /* Form groups take full width on mobile */
        .search-form .form-group {
            width: 100%;
        }

        /* Journey date input full width */
        input#journey_date {
            width: 100%;
        }

        /* Search button full width on mobile */
        .search-form .btn {
            width: 100%;
        }

        /* Station swap button alignment */
        .swap-btn {
            padding-bottom: 0;
            align-items: center;
        }

        /* Universal search filter - single column on mobile */
        .search-filters {
            grid-template-columns: 1fr;
            gap: 15px;
        }

        /* Train grid - stack cards vertically on mobile */
        .trains-grid {
            flex-direction: column;
            align-items: stretch;
        }

        /* Train cards take full width on mobile */
        .train-card {
            width: 100%;
        }
    }

    /* =================================================================
       RESPONSIVE DESIGN - Small Mobile (480px and below)
       ================================================================= */

    @media (max-width: 480px) {
        /* Further reduce padding on very small screens */
        .search-form {
            padding: 1rem;
            margin: 0 0.5rem;
            width: calc(100% - 1rem);
        }

        /* Smaller input fields on very small screens */
        .search-form select,
        .search-form input[type="date"] {
            padding: 0.75rem;
            font-size: 0.95rem;
            width: 100%;
        }

        /* Smaller button on very small screens */
        .search-form .btn {
            padding: 0.75rem 1.5rem;
            font-size: 0.95rem;
            width: 100%;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Hero Section: Main banner with search form -->
<div class="hero-section">
    <div class="hero-content">
        <div class="hero-text-overlay">
            <h1 class="animate-fade-in-down"><i class="fas fa-train floating-icon"></i> Welcome to RailServe 2025</h1>
            <p class="lead animate-fade-in-up">Book your railway tickets with modern technology - fast, secure, and
                reliable</p>
        </div>

        <div class="search-form animate-scale-in">
            <form method="POST" action="{{ url_for('search_trains_route') }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                <div class="form-row">
                    <div id="form-select">
                        <div class="form-group">
                            <label for="from_station">From Station</label>
                            <select name="from_station" id="from_station" required>
                                <option value="">Select Station</option>
                                {% for station in stations %}
                                <option value="{{ station.id }}" {% if from_station and from_station|int==station.id
                                    %}selected{% endif %}>
                                    {{ station.name }} ({{ station.code }})
                                </option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="swap-btn">
                            <button type="button" onclick="swapStations()">
                                <i class="fas fa-exchange-alt"></i>
                            </button>
                        </div>

                        <div class="form-group">
                            <label for="to_station">To Station</label>
                            <select name="to_station" id="to_station" required>
                                <option value="">Select Station</option>
                                {% for station in stations %}
                                <option value="{{ station.id }}" {% if to_station and to_station|int==station.id
                                    %}selected{% endif %}>
                                    {{ station.name }} ({{ station.code }})
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div id="form-select2">

                        <div class="form-group">
                            <label for="journey_date">Journey Date</label>
                            <input type="date" name="journey_date" id="journey_date" value="{{ journey_date or '' }}"
                                required>
                        </div>

                        <div class="form-group">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-search"></i> Search Trains
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="container">
    {% if search_performed %}
    <div class="search-results">
        <h2><i class="fas fa-list"></i> Search Results</h2>

        {% if trains %}
        <div class="trains-grid">
            {% for train in trains %}
            <div class="train-card">
                <div class="train-header">
                    <h3>{{ train.number }} - {{ train.name }}</h3>
                    <span class="train-status {% if train.available_seats > 0 %}available{% else %}waitlist{% endif %}">
                        {% if train.available_seats > 0 %}
                        <i class="fas fa-check-circle"></i> Available
                        {% else %}
                        <i class="fas fa-clock"></i> Waitlist
                        {% endif %}
                    </span>
                </div>

                <div class="train-details">
                    <div class="detail-item">
                        <i class="fas fa-rupee-sign"></i>
                        <span>Base Fare: ₹{{ "%.2f"|format(train.fare_per_km) }}/km</span>
                    </div>
                </div>

                {% if trains_availability and trains_availability[train.id] %}
                <div class="seat-availability-section">
                    <div class="availability-header">
                        <i class="fas fa-chair"></i> Seat Availability
                    </div>
                    <table class="availability-table">
                        <thead>
                            <tr>
                                <th>Class</th>
                                <th>Type</th>
                                <th>Fare</th>
                                <th>Availability</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% set class_info = {
                                'AC1': {'name': 'First AC', 'fare': '5.0x'},
                                'AC2': {'name': 'AC 2 Tier', 'fare': '3.0x'},
                                'AC3': {'name': 'AC 3 Tier', 'fare': '2.0x'},
                                'SL': {'name': 'Sleeper', 'fare': '1.0x'},
                                '2S': {'name': '2nd Sitting', 'fare': '0.6x'},
                                'CC': {'name': 'Chair Car', 'fare': '1.2x'}
                            } %}
                            {% for class_code, avail in trains_availability[train.id].items() %}
                            <tr class="avail-row {% if avail.available > 0 %}row-available{% elif avail.rac > 0 %}row-rac{% else %}row-waitlist{% endif %}">
                                <td class="class-code">{{ class_code }}</td>
                                <td class="class-type">{{ class_info[class_code]['name'] }}</td>
                                <td class="fare-mult">{{ class_info[class_code]['fare'] }}</td>
                                <td class="availability-cell">
                                    {% if avail.available > 0 %}
                                        <span class="avail-badge badge-available">
                                            <i class="fas fa-check-circle"></i> AVAILABLE-{{ '%03d'|format(avail.available) }}
                                        </span>
                                    {% elif avail.rac > 0 %}
                                        <span class="avail-badge badge-rac">
                                            <i class="fas fa-exclamation-circle"></i> RAC-{{ '%02d'|format(avail.rac) }}
                                        </span>
                                    {% else %}
                                        <span class="avail-badge badge-waitlist">
                                            <i class="fas fa-clock"></i> WL-{{ '%02d'|format(avail.waiting) }}
                                        </span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    <div class="availability-footer">
                        <div class="legend-item">
                            <span class="legend-dot dot-available"></span> Available
                        </div>
                        <div class="legend-item">
                            <span class="legend-dot dot-rac"></span> RAC
                        </div>
                        <div class="legend-item">
                            <span class="legend-dot dot-waitlist"></span> Waitlist
                        </div>
                    </div>
                </div>
                {% endif %}

                <div class="train-actions">
                    {% if current_user.is_authenticated %}
                    <a href="{{ url_for('booking.book_ticket', train_id=train.id, from_station=from_station, to_station=to_station, journey_date=journey_date) }}" class="btn btn-primary">
                        <i class="fas fa-ticket-alt"></i> Book Now
                    </a>
                    {% else %}
                    <a href="{{ url_for('auth.login') }}" class="btn btn-secondary">
                        <i class="fas fa-sign-in-alt"></i> Login to Book
                    </a>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="no-results">
            <i class="fas fa-train"></i>
            <h3>No trains found</h3>
            <p>No trains available between the selected stations on {{ journey_date }}.</p>
        </div>
        {% endif %}
    </div>
    {% else %}
    <div class="running-trains">
        <h2><i class="fas fa-train"></i> Popular Trains</h2>

        {% if trains %}
        <div class="trains-grid">
            {% for train in trains[:6] %}
            <div class="train-card">
                <div class="train-header">
                    <h3>{{ train.number }} - {{ train.name }}</h3>
                    <span class="train-status available">
                        <i class="fas fa-check-circle"></i> Active
                    </span>
                </div>

                <div class="train-details">
                    <div class="detail-item">
                        <i class="fas fa-chair"></i>
                        <span>Total Seats: {{ train.total_seats }}</span>
                    </div>
                    <div class="detail-item">
                        <i class="fas fa-rupee-sign"></i>
                        <span>Base Fare: ₹{{ "%.2f"|format(train.fare_per_km) }}/km</span>
                    </div>
                </div>

                {% if trains_availability and trains_availability[train.id] %}
                <div class="seat-availability-section">
                    <div class="availability-header">
                        <i class="fas fa-chair"></i> Seat Availability (Sample Route)
                    </div>
                    <table class="availability-table">
                        <thead>
                            <tr>
                                <th>Class</th>
                                <th>Type</th>
                                <th>Fare</th>
                                <th>Availability</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% set class_info = {
                                'AC1': {'name': 'First AC', 'fare': '5.0x'},
                                'AC2': {'name': 'AC 2 Tier', 'fare': '3.0x'},
                                'AC3': {'name': 'AC 3 Tier', 'fare': '2.0x'},
                                'SL': {'name': 'Sleeper', 'fare': '1.0x'},
                                '2S': {'name': '2nd Sitting', 'fare': '0.6x'},
                                'CC': {'name': 'Chair Car', 'fare': '1.2x'}
                            } %}
                            {% for class_code, avail in trains_availability[train.id].items() %}
                            <tr class="avail-row {% if avail.available > 0 %}row-available{% elif avail.rac > 0 %}row-rac{% else %}row-waitlist{% endif %}">
                                <td class="class-code">{{ class_code }}</td>
                                <td class="class-type">{{ class_info[class_code]['name'] }}</td>
                                <td class="fare-mult">{{ class_info[class_code]['fare'] }}</td>
                                <td class="availability-cell">
                                    {% if avail.available > 0 %}
                                        <span class="avail-badge badge-available">
                                            <i class="fas fa-check-circle"></i> AVAILABLE-{{ '%03d'|format(avail.available) }}
                                        </span>
                                    {% elif avail.rac > 0 %}
                                        <span class="avail-badge badge-rac">
                                            <i class="fas fa-exclamation-circle"></i> RAC-{{ '%02d'|format(avail.rac) }}
                                        </span>
                                    {% else %}
                                        <span class="avail-badge badge-waitlist">
                                            <i class="fas fa-clock"></i> WL-{{ '%02d'|format(avail.waiting) }}
                                        </span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    <div class="availability-footer">
                        <div class="legend-item">
                            <span class="legend-dot dot-available"></span> Available
                        </div>
                        <div class="legend-item">
                            <span class="legend-dot dot-rac"></span> RAC
                        </div>
                        <div class="legend-item">
                            <span class="legend-dot dot-waitlist"></span> Waitlist
                        </div>
                    </div>
                </div>
                {% endif %}

                <div class="train-actions">
                    {% if current_user.is_authenticated %}
                    <a href="{{ url_for('booking.book_ticket', train_id=train.id) }}" class="btn btn-primary">
                        <i class="fas fa-ticket-alt"></i> Book Ticket
                    </a>
                    {% else %}
                    <a href="{{ url_for('auth.login') }}" class="btn btn-secondary">
                        <i class="fas fa-sign-in-alt"></i> Login to Book
                    </a>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="no-results">
            <i class="fas fa-train"></i>
            <h3>No trains available</h3>
            <p>Please check back later.</p>
        </div>
        {% endif %}
    </div>
    {% endif %}
</div>

<div class="features-section">
    <div class="container">
        <h2 class="animate-fade-in">Why Choose RailServe?</h2>
        <div class="features-grid">
            <div class="feature-card animate-fade-in-up scroll-reveal">
                <i class="fas fa-shield-alt floating-icon"></i>
                <h3>Secure Booking</h3>
                <p>Your transactions are protected with advanced security measures</p>
            </div>
            <div class="feature-card animate-fade-in-up scroll-reveal">
                <i class="fas fa-clock floating-icon"></i>
                <h3>24/7 Service</h3>
                <p>Book tickets anytime, anywhere with our round-the-clock service</p>
            </div>
            <div class="feature-card animate-fade-in-up scroll-reveal">
                <i class="fas fa-mobile-alt floating-icon"></i>
                <h3>Mobile Friendly</h3>
                <p>Easy booking experience on all devices</p>
            </div>
            <div class="feature-card animate-fade-in-up scroll-reveal">
                <i class="fas fa-headset floating-icon"></i>
                <h3>Customer Support</h3>
                <p>Get help when you need it with our dedicated support team</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    /**
     * =================================================================
     * RailServe Homepage - Station Swap & Date Validation Scripts
     * =================================================================
     */

    /**
     * Swap Stations Function
     * Swaps the selected values between 'From Station' and 'To Station' dropdowns
     */
    function swapStations() {
        const fromSelect = document.getElementById('from_station');
        const toSelect = document.getElementById('to_station');

        if (fromSelect && toSelect) {
            const fromValue = fromSelect.value;
            const toValue = toSelect.value;

            fromSelect.value = toValue;
            toSelect.value = fromValue;
        }
    }

    /**
     * Initialize Date Restrictions
     * Sets minimum date to today for journey date input to prevent past bookings
     */
    document.addEventListener('DOMContentLoaded', function () {
        const journeyDate = document.getElementById('journey_date');
        if (journeyDate) {
            // Set minimum date to today
            journeyDate.min = new Date().toISOString().split('T')[0];
        }
    });
</script>
{% endblock %}
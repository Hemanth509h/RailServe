{% extends "base.html" %}

{% block title %}Seat Selection - {{ group.group_name }} - RailServe{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <!-- Header -->
            <div class="card shadow mb-4">
                <div class="card-header bg-primary text-white">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h2 class="mb-0">
                                <i class="fas fa-chair"></i> Seat Selection - {{ group.group_name }}
                            </h2>
                            <p class="mb-0 mt-1">Visual seat selection for group booking</p>
                        </div>
                        <div class="col-md-4 text-end">
                            <a href="{{ url_for('modern_groups.manage_group', group_id=group.id) }}" class="btn btn-light btn-sm">
                                <i class="fas fa-arrow-left"></i> Back to Group
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Seat Maps -->
            {% if seat_maps %}
            {% for seat_map_data in seat_maps %}
            <div class="card mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="fas fa-train"></i> {{ seat_map_data.train_name }} - 
                        Coach Class: {{ seat_map_data.coach_class }}
                    </h5>
                    <p class="mb-0 mt-2 small text-muted">
                        Select seats for your group members. Click on available seats to select/deselect.
                    </p>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('modern_groups.save_seat_selection', group_id=group.id) }}" id="seat-selection-form-{{ loop.index }}">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <input type="hidden" name="booking_id" value="{{ seat_map_data.booking_id if seat_map_data.booking_id else '' }}"/>
                        <input type="hidden" name="selected_seats" id="selected-seats-{{ loop.index }}" value=""/>
                        
                        <div class="row mb-3">
                            <div class="col-md-8">
                                <div class="seat-map-container p-3 bg-light rounded">
                                    <!-- Coach Layout -->
                                    <div class="coach-layout">
                                        <div class="text-center mb-3">
                                            <small class="text-muted">Front of Coach</small>
                                        </div>
                                        
                                        <!-- Generate seat grid based on coach class -->
                                        <div class="seat-grid">
                                            {% set outer_loop_index = loop.index %}
                                            {% set seats_per_row = 4 if seat_map_data.coach_class in ['AC1', 'AC2'] else 6 %}
                                            {% set total_seats = 72 if seat_map_data.coach_class == 'SL' else 64 if seat_map_data.coach_class == 'AC3' else 48 %}
                                            {% set has_seat_map = seat_map_data.seat_map is defined and seat_map_data.seat_map is not none %}
                                            {% set occupied_seats = seat_map_data.seat_map.occupied_seats if has_seat_map and seat_map_data.seat_map.occupied_seats else [] %}
                                            {% set allocated_seats = seat_map_data.seat_map.allocated_seats if has_seat_map and seat_map_data.seat_map.allocated_seats else [] %}
                                            
                                            {% for row in range((total_seats // seats_per_row)) %}
                                            <div class="seat-row mb-2 d-flex justify-content-center">
                                                {% for col in range(seats_per_row) %}
                                                {% set seat_num = (row * seats_per_row) + col + 1 %}
                                                {% set seat_id = seat_map_data.coach_class ~ '-' ~ seat_num %}
                                                {% set seat_type = 'LB' if seat_num % 8 == 0 else 'MB' if seat_num % 8 in [3, 4] else 'UB' if seat_num % 2 == 0 else 'WS' %}
                                                {% set is_occupied = seat_id in occupied_seats if has_seat_map else (seat_num % 7 == 0) %}
                                                {% set is_allocated = seat_id in allocated_seats %}
                                                
                                                <button type="button" 
                                                        class="seat-btn {{ 'occupied' if is_occupied else 'selected' if is_allocated else 'available' }}" 
                                                        data-seat="{{ seat_id }}"
                                                        data-seat-type="{{ seat_type }}"
                                                        data-form-id="{{ outer_loop_index }}"
                                                        {% if is_occupied %}disabled{% endif %}
                                                        title="Seat {{ seat_num }} ({{ seat_type }})">
                                                    <span class="seat-number">{{ seat_num }}</span>
                                                    <small class="seat-type-label">{{ seat_type }}</small>
                                                </button>
                                                
                                                {% if col == (seats_per_row // 2) - 1 %}
                                                <div class="aisle"></div>
                                                {% endif %}
                                                {% endfor %}
                                            </div>
                                            
                                            {% if row % 4 == 3 %}
                                            <div class="compartment-divider"></div>
                                            {% endif %}
                                            {% endfor %}
                                        </div>
                                        
                                        <div class="text-center mt-3">
                                            <small class="text-muted">Rear of Coach</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-header bg-primary text-white">
                                        <h6 class="mb-0">Selected Seats</h6>
                                    </div>
                                    <div class="card-body">
                                        <div id="selected-seats-display-{{ loop.index }}" class="mb-3">
                                            <p class="text-muted small">No seats selected</p>
                                        </div>
                                        <hr>
                                        <p class="mb-2"><strong>Passengers:</strong> {{ group.estimated_passengers }}</p>
                                        <p class="mb-2"><strong>Selected:</strong> <span id="selected-count-{{ loop.index }}">0</span></p>
                                        <hr>
                                        <button type="submit" class="btn btn-success w-100">
                                            <i class="fas fa-check"></i> Confirm Selection
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary w-100 mt-2" onclick="clearSeats({{ loop.index }})">
                                            <i class="fas fa-times"></i> Clear All
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            {% endfor %}
            {% else %}
            <div class="card">
                <div class="card-body text-center py-5">
                    <i class="fas fa-exclamation-circle fa-3x text-muted mb-3"></i>
                    <h5>No Bookings Available</h5>
                    <p class="text-muted">Add train bookings to your group before selecting seats.</p>
                    <a href="{{ url_for('modern_groups.manage_group', group_id=group.id) }}" class="btn btn-primary">
                        <i class="fas fa-plus"></i> Add Booking
                    </a>
                </div>
            </div>
            {% endif %}

            <!-- Seat Legend -->
            {% if seat_maps %}
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="fas fa-list"></i> Seat Legend</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="d-flex align-items-center mb-2">
                                <div class="seat-indicator bg-success me-2" style="width: 30px; height: 30px;"></div>
                                <span>Available</span>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="d-flex align-items-center mb-2">
                                <div class="seat-indicator bg-danger me-2" style="width: 30px; height: 30px;"></div>
                                <span>Occupied</span>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="d-flex align-items-center mb-2">
                                <div class="seat-indicator bg-primary me-2" style="width: 30px; height: 30px;"></div>
                                <span>Selected</span>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="d-flex align-items-center mb-2">
                                <div class="seat-indicator bg-warning me-2" style="width: 30px; height: 30px;"></div>
                                <span>Reserved (Group)</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<style>
.seat-indicator {
    border-radius: 4px;
    border: 1px solid #dee2e6;
}

.seat-grid {
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.seat-row {
    display: flex;
    gap: 8px;
    align-items: center;
}

.seat-btn {
    width: 50px;
    height: 60px;
    border: 2px solid #dee2e6;
    border-radius: 8px;
    background: #fff;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    font-size: 11px;
    padding: 4px;
}

.seat-btn:hover:not(:disabled) {
    transform: scale(1.05);
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
}

.seat-btn.available {
    background: #d4edda;
    border-color: #28a745;
}

.seat-btn.available:hover {
    background: #c3e6cb;
}

.seat-btn.occupied {
    background: #f8d7da;
    border-color: #dc3545;
    cursor: not-allowed;
    opacity: 0.6;
}

.seat-btn.selected {
    background: #0d6efd;
    border-color: #0d6efd;
    color: white;
}

.seat-btn.selected:hover {
    background: #0b5ed7;
}

.seat-number {
    font-weight: bold;
    font-size: 14px;
}

.seat-type-label {
    font-size: 9px;
    opacity: 0.8;
}

.aisle {
    width: 30px;
    height: 60px;
    border-left: 2px dashed #ccc;
    border-right: 2px dashed #ccc;
    background: linear-gradient(to right, #f8f9fa, #e9ecef, #f8f9fa);
}

.compartment-divider {
    height: 10px;
    border-bottom: 2px solid #dee2e6;
    margin: 10px 0;
}

#selected-seats-display {
    min-height: 100px;
    max-height: 300px;
    overflow-y: auto;
}

.selected-seat-badge {
    display: inline-block;
    background: #0d6efd;
    color: white;
    padding: 4px 8px;
    margin: 2px;
    border-radius: 4px;
    font-size: 12px;
}
</style>

<script>
// Track selected seats for each form
const selectedSeatsMap = {};

function initializeSeatSelection() {
    const seatButtons = document.querySelectorAll('.seat-btn:not(.occupied)');
    
    // Initialize pre-selected seats
    seatButtons.forEach(btn => {
        if (btn.classList.contains('selected')) {
            const formId = btn.getAttribute('data-form-id');
            const seatId = btn.getAttribute('data-seat');
            
            if (!selectedSeatsMap[formId]) {
                selectedSeatsMap[formId] = [];
            }
            if (!selectedSeatsMap[formId].includes(seatId)) {
                selectedSeatsMap[formId].push(seatId);
            }
        }
    });
    
    // Update displays for pre-selected seats
    Object.keys(selectedSeatsMap).forEach(formId => {
        updateSeatDisplay(formId);
    });
    
    // Add click handlers
    seatButtons.forEach(btn => {
        btn.addEventListener('click', function() {
            const formId = this.getAttribute('data-form-id');
            const seatId = this.getAttribute('data-seat');
            const seatType = this.getAttribute('data-seat-type');
            
            if (!selectedSeatsMap[formId]) {
                selectedSeatsMap[formId] = [];
            }
            
            if (this.classList.contains('selected')) {
                // Deselect
                this.classList.remove('selected');
                const index = selectedSeatsMap[formId].indexOf(seatId);
                if (index > -1) {
                    selectedSeatsMap[formId].splice(index, 1);
                }
            } else {
                // Select
                this.classList.add('selected');
                if (!selectedSeatsMap[formId].includes(seatId)) {
                    selectedSeatsMap[formId].push(seatId);
                }
            }
            
            updateSeatDisplay(formId);
        });
    });
}

function updateSeatDisplay(formId) {
    const selectedSeats = selectedSeatsMap[formId] || [];
    const displayDiv = document.getElementById(`selected-seats-display-${formId}`);
    const countSpan = document.getElementById(`selected-count-${formId}`);
    const hiddenInput = document.getElementById(`selected-seats-${formId}`);
    
    if (countSpan) {
        countSpan.textContent = selectedSeats.length;
    }
    
    if (hiddenInput) {
        hiddenInput.value = selectedSeats.join(',');
    }
    
    if (displayDiv) {
        if (selectedSeats.length === 0) {
            displayDiv.innerHTML = '<p class="text-muted small">No seats selected</p>';
        } else {
            displayDiv.innerHTML = selectedSeats.map(seat => 
                `<span class="selected-seat-badge">${seat}</span>`
            ).join('');
        }
    }
}

function clearSeats(formId) {
    selectedSeatsMap[formId] = [];
    
    const seatButtons = document.querySelectorAll(`[data-form-id="${formId}"]`);
    seatButtons.forEach(btn => {
        btn.classList.remove('selected');
    });
    
    updateSeatDisplay(formId);
}

// Initialize when page loads
document.addEventListener('DOMContentLoaded', initializeSeatSelection);
</script>
{% endblock %}
